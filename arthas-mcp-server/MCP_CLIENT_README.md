# Arthas MCP Client - åå‘è¿æ¥æ¨¡å¼è®¾è®¡è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

Arthas MCP Client æ˜¯ä¸€ä¸ªåå‘è¿æ¥æ¨¡å¼çš„å®ç°ï¼Œå…è®¸ Arthas ä¸»åŠ¨è¿æ¥åˆ°è¿œç¨‹çš„ MCP Serverï¼ˆç®¡æ§å¹³å°ï¼‰ï¼Œè€Œä¸æ˜¯è¢«åŠ¨ç­‰å¾…è¿æ¥ã€‚

**é‡‡ç”¨ HTTP/SSE åè®®**ï¼Œä¸åŸæœ‰ MCP Server ä¿æŒä¸€è‡´ã€‚

### åº”ç”¨åœºæ™¯
- å†…ç½‘æœåŠ¡æ— æ³•æš´éœ²ç«¯å£åˆ°å…¬ç½‘çš„åœºæ™¯
- æ™ºèƒ½ä½“éƒ¨ç½²åœ¨äº‘ç«¯ï¼Œéœ€è¦è®¿é—®å†…ç½‘ Arthas çš„åœºæ™¯
- éœ€è¦ç»Ÿä¸€ç®¡ç†å¤šä¸ª Arthas å®ä¾‹çš„åœºæ™¯

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç®¡æ§å¹³å°ï¼ˆå…¬ç½‘ï¼‰                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  SSE Endpoint   â”‚    â”‚  POST Handler   â”‚    â”‚  å·¥å…·è°ƒç”¨        â”‚     â”‚
â”‚  â”‚  GET /mcp       â”‚    â”‚  POST /mcp      â”‚    â”‚  å‘é€è¯·æ±‚        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚ SSE äº‹ä»¶æµ           â”‚ JSON-RPC            â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                      â”‚                      â”‚
            â”‚ Arthas å»ºç«‹ SSE è¿æ¥  â”‚ Arthas å‘é€å“åº”       â”‚ ç®¡æ§å¹³å°å‘é€è¯·æ±‚
            â”‚                      â”‚                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Arthas MCP Clientï¼ˆå†…ç½‘ï¼‰                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  SSE Client     â”‚    â”‚  HTTP POST      â”‚    â”‚  å·¥å…·æ‰§è¡Œ        â”‚     â”‚
â”‚  â”‚  ç›‘å¬è¯·æ±‚        â”‚    â”‚  å‘é€å“åº”        â”‚    â”‚  jvm/threadç­‰    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—å¤ç”¨å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     arthas-mcp-server                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    å·²æœ‰æ¨¡å— (å¤ç”¨)                        â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  â€¢ McpSchema           - JSON-RPC æ¶ˆæ¯å®šä¹‰              â”‚  â”‚
â”‚  â”‚  â€¢ ToolCallback        - å·¥å…·å›è°ƒæ¥å£                   â”‚  â”‚
â”‚  â”‚  â€¢ ToolCallbackProvider - å·¥å…·æä¾›è€…æ¥å£                â”‚  â”‚
â”‚  â”‚  â€¢ DefaultToolCallbackProvider - é»˜è®¤å·¥å…·æ‰«æå®ç°       â”‚  â”‚
â”‚  â”‚  â€¢ JsonParser          - JSON åºåˆ—åŒ–å·¥å…·                â”‚  â”‚
â”‚  â”‚  â€¢ io.netty.*          - Netty ç½‘ç»œæ¡†æ¶                 â”‚  â”‚
â”‚  â”‚  â€¢ ProtocolVersions    - åè®®ç‰ˆæœ¬å®šä¹‰                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    æ–°å¢æ¨¡å— (Client)                      â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  protocol/client/                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ McpClientConfig.java        - å®¢æˆ·ç«¯é…ç½®           â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ ArthasMcpClient.java        - ä¸»å®¢æˆ·ç«¯ç±»           â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ McpHttpClient.java          - HTTP/SSE å®¢æˆ·ç«¯      â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ McpClientProtocolHandler.java - åè®®å¤„ç†å™¨         â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ ReconnectStrategy.java      - é‡è¿ç­–ç•¥             â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ HeartbeatManager.java       - å¿ƒè·³ç®¡ç†             â”‚  â”‚
â”‚  â”‚  â””â”€â”€ McpClientBootstrap.java     - æµ‹è¯•å…¥å£             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç±»èŒè´£è¯´æ˜

| ç±»å | èŒè´£ | å¤ç”¨çš„å·²æœ‰æ¨¡å— |
|-----|------|--------------:|
| `McpClientConfig` | é…ç½®ç®¡ç†ï¼Œæ”¯æŒç¯å¢ƒå˜é‡ | æ—  |
| `ArthasMcpClient` | æ•´åˆæ‰€æœ‰ç»„ä»¶ï¼Œæä¾›ç»Ÿä¸€ API | `ToolCallbackProvider` |
| `McpHttpClient` | HTTP/SSE è¿æ¥ç®¡ç† | `io.netty.*`, `ObjectMapper` |
| `McpClientProtocolHandler` | MCP åè®®å¤„ç† | `McpSchema`, `ToolCallback`, `JsonParser` |
| `ReconnectStrategy` | æŒ‡æ•°é€€é¿é‡è¿ç­–ç•¥ | æ—  |
| `HeartbeatManager` | å¿ƒè·³å‘é€å’Œè¶…æ—¶æ£€æµ‹ | æ—  |

## ğŸ“ è¯¦ç»†è®¾è®¡

### 1. McpClientConfig - é…ç½®ç±»

```java
// æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
ç¯å¢ƒå˜é‡                                    | è¯´æ˜
--------------------------------------------|------------------
ARTHAS_MCP_CLIENT_SERVER_URL                | æœåŠ¡ç«¯ HTTP åœ°å€
ARTHAS_MCP_CLIENT_AUTH_TOKEN                | è®¤è¯ Token
ARTHAS_MCP_CLIENT_RECONNECT_ENABLED         | æ˜¯å¦å¯ç”¨è‡ªåŠ¨é‡è¿
ARTHAS_MCP_CLIENT_HEARTBEAT_INTERVAL        | å¿ƒè·³é—´éš”ï¼ˆæ¯«ç§’ï¼‰
ARTHAS_MCP_CLIENT_CONNECT_TIMEOUT           | è¿æ¥è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
ARTHAS_MCP_CLIENT_REQUEST_TIMEOUT           | è¯·æ±‚è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
ARTHAS_MCP_CLIENT_SSE_RECONNECT_DELAY       | SSE é‡è¿å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
```

### 2. ArthasMcpClient - ä¸»å®¢æˆ·ç«¯ç±»

```java
// çŠ¶æ€æœº
DISCONNECTED -> CONNECTING -> CONNECTED
                    â†“             â†“
              RECONNECTING  <-----+
                    â†“
                 STOPPED
```

**æ ¸å¿ƒæµç¨‹ï¼š**
1. åŠ è½½é…ç½®
2. ä» `ToolCallbackProvider` è·å–æ‰€æœ‰å·¥å…·
3. å»ºç«‹ SSE è¿æ¥åˆ°ç®¡æ§å¹³å°
4. å‘é€ `initialize` è¯·æ±‚
5. å‘é€ `initialized` é€šçŸ¥
6. å¯åŠ¨å¿ƒè·³
7. ç›‘å¬ SSE äº‹ä»¶å¤„ç†ç®¡æ§å¹³å°è¯·æ±‚

### 3. McpHttpClient - HTTP/SSE å®¢æˆ·ç«¯

**å¤ç”¨çš„ Netty ç»„ä»¶ï¼š**
- `Bootstrap` - å®¢æˆ·ç«¯å¯åŠ¨å™¨
- `NioEventLoopGroup` - äº‹ä»¶å¾ªç¯ç»„
- `HttpClientCodec` - HTTP ç¼–è§£ç å™¨
- `HttpObjectAggregator` - HTTP æ¶ˆæ¯èšåˆå™¨
- `SslContext` - SSL ä¸Šä¸‹æ–‡ï¼ˆhttps:// æ”¯æŒï¼‰

**é€šä¿¡æ¨¡å¼ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      McpHttpClient                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  SSE è¿æ¥ï¼ˆé•¿è¿æ¥ï¼‰                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  GET /mcp                                                â”‚   â”‚
â”‚  â”‚  Accept: text/event-stream                              â”‚   â”‚
â”‚  â”‚  Authorization: Bearer <token>                          â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  <- event: message                                      â”‚   â”‚
â”‚  â”‚  <- data: {"jsonrpc":"2.0","method":"tools/call",...}   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  HTTP POSTï¼ˆçŸ­è¿æ¥ï¼Œå‘é€å“åº”ï¼‰                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  POST /mcp                                              â”‚   â”‚
â”‚  â”‚  Content-Type: application/json                         â”‚   â”‚
â”‚  â”‚  Mcp-Session-Id: <session-id>                           â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  -> {"jsonrpc":"2.0","id":1,"result":{...}}            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. McpClientProtocolHandler - åè®®å¤„ç†å™¨

**å¤ç”¨çš„ç»„ä»¶ï¼š**
- `McpSchema.Tool` - å·¥å…·å®šä¹‰
- `McpSchema.JSONRPCRequest/Response` - æ¶ˆæ¯æ ¼å¼
- `ToolCallback.call()` - å·¥å…·æ‰§è¡Œ
- `JsonParser.getObjectMapper()` - JSON åºåˆ—åŒ–

**å¤„ç†çš„è¯·æ±‚ï¼ˆæ¥è‡ªç®¡æ§å¹³å°ï¼‰ï¼š**

| æ–¹æ³• | å¤„ç†é€»è¾‘ |
|-----|---------:|
| `tools/list` | éå†å·²æ³¨å†Œçš„ ToolCallbackï¼Œè¿”å›å·¥å…·åˆ—è¡¨ |
| `tools/call` | æŸ¥æ‰¾å¯¹åº”çš„ ToolCallbackï¼Œæ‰§è¡Œå¹¶è¿”å›ç»“æœ |
| `ping` | è¿”å›ç©ºå“åº” |

**å‘é€çš„è¯·æ±‚ï¼ˆåˆ°ç®¡æ§å¹³å°ï¼‰ï¼š**

| æ–¹æ³• | è§¦å‘æ—¶æœº |
|-----|---------:|
| `initialize` | SSE è¿æ¥å»ºç«‹å |
| `notifications/initialized` | initialize æˆåŠŸå |
| `ping` | å¿ƒè·³ |

## ğŸ“¡ åè®®æµç¨‹

### è¿æ¥å»ºç«‹æµç¨‹

```
Arthas Client                              ç®¡æ§å¹³å°
      |                                         |
      |  1. å»ºç«‹ SSE è¿æ¥                        |
      |  GET /mcp                               |
      |  Accept: text/event-stream              |
      |---------------------------------------->|
      |                                         |
      |  2. SSE è¿æ¥å»ºç«‹                         |
      |  HTTP 200                               |
      |  Content-Type: text/event-stream        |
      |  Mcp-Session-Id: <session-id>           |
      |<----------------------------------------|
      |                                         |
      |  3. å‘é€ initialize è¯·æ±‚                 |
      |  POST /mcp                              |
      |  {method: "initialize", ...}            |
      |---------------------------------------->|
      |                                         |
      |  4. initialize å“åº”                      |
      |  {result: {serverInfo, capabilities}}   |
      |<----------------------------------------|
      |                                         |
      |  5. å‘é€ initialized é€šçŸ¥               |
      |  POST /mcp                              |
      |  {method: "notifications/initialized"}  |
      |---------------------------------------->|
      |                                         |
      |  6. 202 Accepted                        |
      |<----------------------------------------|
      |                                         |
      |  === è¿æ¥å»ºç«‹å®Œæˆï¼Œå¼€å§‹å¿ƒè·³ ===           |
```

### å·¥å…·è°ƒç”¨æµç¨‹

```
Arthas Client                              ç®¡æ§å¹³å°
      |                                         |
      |  tools/call è¯·æ±‚ï¼ˆé€šè¿‡ SSEï¼‰             |
      |  event: message                         |
      |  data: {method: "tools/call",           |
      |         params: {name, arguments}}      |
      |<----------------------------------------|
      |                                         |
      |  æ‰§è¡Œå·¥å…·: ToolCallback.call()          |
      |  (å¤ç”¨ Arthas ç°æœ‰å·¥å…·å®ç°)              |
      |                                         |
      |  è¿”å›æ‰§è¡Œç»“æœï¼ˆé€šè¿‡ HTTP POSTï¼‰           |
      |  POST /mcp                              |
      |  {result: {content: [{type, text}]}}    |
      |---------------------------------------->|
      |                                         |
      |  202 Accepted                           |
      |<----------------------------------------|
```

### å¿ƒè·³ä¿æ´»æµç¨‹

```
Arthas Client                              ç®¡æ§å¹³å°
      |                                         |
      |  æ¯ 30 ç§’å‘é€ä¸€æ¬¡ ping                   |
      |  POST /mcp                              |
      |  {method: "ping"}                       |
      |---------------------------------------->|
      |                                         |
      |  è¿”å›å“åº”                                |
      |  {result: {}}                           |
      |<----------------------------------------|
      |                                         |
      |  å¦‚æœè¯·æ±‚è¶…æ—¶ï¼Œè§¦å‘é‡è¿                   |
```

## ğŸ”§ ä½¿ç”¨æ–¹å¼

MCP Client åŠŸèƒ½å·²ç»**é›†æˆåˆ° Arthas ä¸»å¯åŠ¨æµç¨‹**ä¸­ï¼Œæ— éœ€å•ç‹¬å¯åŠ¨ã€‚

### å¯åŠ¨æ¨¡å¼è¯´æ˜

Arthas MCP æ”¯æŒä¸¤ç§å·¥ä½œæ¨¡å¼ï¼Œå¯ä»¥åŒæ—¶å¯ç”¨ï¼š

| æ¨¡å¼ | è¯´æ˜ | å¯ç”¨æ¡ä»¶ |
|------|------|----------|
| **Server æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰** | ç­‰å¾…å¤–éƒ¨ MCP å®¢æˆ·ç«¯è¿æ¥ | é»˜è®¤å¯ç”¨ |
| **Client æ¨¡å¼ï¼ˆåå‘è¿æ¥ï¼‰** | ä¸»åŠ¨è¿æ¥åˆ°ç®¡æ§å¹³å° | è®¾ç½® `ARTHAS_MCP_CLIENT_SERVER_URL` |

### æ–¹å¼ä¸€ï¼šé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼ˆæ¨èï¼‰

```bash
# ==============================
# æœ€ç®€é…ç½®ï¼šåªéœ€è®¾ç½®æœåŠ¡ç«¯åœ°å€å³å¯å¯ç”¨ Client æ¨¡å¼
# ==============================
export ARTHAS_MCP_CLIENT_SERVER_URL=http://your-server.com:8080/mcp

# å¯åŠ¨ Arthasï¼ˆåŒæ—¶å¯åŠ¨ Server å’Œ Client æ¨¡å¼ï¼‰
java -jar arthas-boot.jar

# ==============================
# å®Œæ•´é…ç½®ç¤ºä¾‹
# ==============================
# å¿…å¡«ï¼šç®¡æ§å¹³å°åœ°å€
export ARTHAS_MCP_CLIENT_SERVER_URL=http://your-server.com:8080/mcp

# å¯é€‰ï¼šè®¤è¯ Token
export ARTHAS_MCP_CLIENT_AUTH_TOKEN=your-token

# å¯é€‰ï¼šé‡è¿é…ç½®
export ARTHAS_MCP_CLIENT_RECONNECT_ENABLED=true
export ARTHAS_MCP_CLIENT_RECONNECT_INITIAL_DELAY=5000
export ARTHAS_MCP_CLIENT_RECONNECT_MAX_DELAY=300000

# å¯é€‰ï¼šå¿ƒè·³é…ç½®
export ARTHAS_MCP_CLIENT_HEARTBEAT_ENABLED=true
export ARTHAS_MCP_CLIENT_HEARTBEAT_INTERVAL=30000

# å¯é€‰ï¼šè¶…æ—¶é…ç½®
export ARTHAS_MCP_CLIENT_CONNECT_TIMEOUT=10000
export ARTHAS_MCP_CLIENT_REQUEST_TIMEOUT=30000

# å¯é€‰ï¼šå®¢æˆ·ç«¯ä¿¡æ¯
export ARTHAS_MCP_CLIENT_CLIENT_NAME=my-arthas-client
export ARTHAS_MCP_CLIENT_CLIENT_VERSION=4.1.5

# å¯åŠ¨ Arthas
java -jar arthas-boot.jar
```

### æ–¹å¼äºŒï¼šåªå¯ç”¨ Client æ¨¡å¼ï¼ˆä¸å¯åŠ¨ Serverï¼‰

å¦‚æœä½ çš„ Arthas å®ä¾‹ä¸éœ€è¦æš´éœ²ç«¯å£ï¼Œåªéœ€è¦åå‘è¿æ¥åˆ°ç®¡æ§å¹³å°ï¼š

```bash
# è®¾ç½®åªå¯ç”¨ Client æ¨¡å¼
export ARTHAS_MCP_CLIENT_ONLY=true

# è®¾ç½®ç®¡æ§å¹³å°åœ°å€
export ARTHAS_MCP_CLIENT_SERVER_URL=http://your-server.com:8080/mcp

# å¯åŠ¨ Arthasï¼ˆåªå¯åŠ¨ Client æ¨¡å¼ï¼Œä¸å¯åŠ¨ Serverï¼‰
java -jar arthas-boot.jar
```

### æ–¹å¼ä¸‰ï¼šä»£ç æ–¹å¼é›†æˆ

å¦‚æœéœ€è¦åœ¨ä»£ç ä¸­æ‰‹åŠ¨æ§åˆ¶ï¼š

```java
// åˆ›å»ºå®¢æˆ·ç«¯
ArthasMcpClient client = ArthasMcpClient.create("http://localhost:8080/mcp")
    .authToken("your-token")
    .reconnectEnabled(true)
    .heartbeatEnabled(true)
    .toolCallbackProvider(provider)
    .build();

// å¯åŠ¨
client.start()
    .thenRun(() -> System.out.println("Connected!"))
    .exceptionally(ex -> { ex.printStackTrace(); return null; });
```

### ç¯å¢ƒå˜é‡å®Œæ•´åˆ—è¡¨

| ç¯å¢ƒå˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|---------|------|--------|
| `ARTHAS_MCP_CLIENT_SERVER_URL` | ç®¡æ§å¹³å° HTTP åœ°å€ï¼ˆå¿…å¡«ï¼‰ | æ—  |
| `ARTHAS_MCP_CLIENT_AUTH_TOKEN` | è®¤è¯ Token | æ—  |
| `ARTHAS_MCP_CLIENT_ONLY` | åªå¯ç”¨ Client æ¨¡å¼ | `false` |
| `ARTHAS_MCP_CLIENT_RECONNECT_ENABLED` | æ˜¯å¦å¯ç”¨è‡ªåŠ¨é‡è¿ | `true` |
| `ARTHAS_MCP_CLIENT_RECONNECT_INITIAL_DELAY` | é‡è¿åˆå§‹å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ | `5000` |
| `ARTHAS_MCP_CLIENT_RECONNECT_MAX_DELAY` | é‡è¿æœ€å¤§å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ | `300000` |
| `ARTHAS_MCP_CLIENT_RECONNECT_MULTIPLIER` | é‡è¿å»¶è¿Ÿå€æ•° | `2.0` |
| `ARTHAS_MCP_CLIENT_HEARTBEAT_ENABLED` | æ˜¯å¦å¯ç”¨å¿ƒè·³ | `true` |
| `ARTHAS_MCP_CLIENT_HEARTBEAT_INTERVAL` | å¿ƒè·³é—´éš”ï¼ˆæ¯«ç§’ï¼‰ | `30000` |
| `ARTHAS_MCP_CLIENT_HEARTBEAT_TIMEOUT` | å¿ƒè·³è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ | `10000` |
| `ARTHAS_MCP_CLIENT_CONNECT_TIMEOUT` | è¿æ¥è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ | `10000` |
| `ARTHAS_MCP_CLIENT_REQUEST_TIMEOUT` | è¯·æ±‚è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ | `30000` |
| `ARTHAS_MCP_CLIENT_SSE_RECONNECT_DELAY` | SSE é‡è¿å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ | `3000` |
| `ARTHAS_MCP_CLIENT_CLIENT_NAME` | å®¢æˆ·ç«¯åç§° | `arthas-mcp-client` |
| `ARTHAS_MCP_CLIENT_CLIENT_VERSION` | å®¢æˆ·ç«¯ç‰ˆæœ¬ | `4.1.5` |

### å¯åŠ¨æ—¥å¿—ç¤ºä¾‹

æˆåŠŸå¯åŠ¨åï¼Œæ—¥å¿—ä¸­ä¼šæ˜¾ç¤ºï¼š

```
# Server æ¨¡å¼å¯åŠ¨
INFO  - Starting MCP Server mode...
INFO  - Arthas MCP Server mode started successfully
INFO  - - MCP Endpoint: /mcp
INFO  - - Transport mode: STREAMABLE
INFO  - - Available tools: 12
INFO  - - Server ready to accept connections

# Client æ¨¡å¼å¯åŠ¨
INFO  - Starting MCP Client mode (Reverse Connection)...
INFO  - - Target Server URL: http://your-server.com:8080/mcp
INFO  - - Auth Token: configured
INFO  - MCP Client mode initialization completed
INFO  - ========================================
INFO  -   MCP Client Connected Successfully!
INFO  - ========================================
INFO  - - Server Info: Implementation[name=mcp-server, version=1.0.0]
INFO  - - Client State: CONNECTED
```

## ğŸ§ª æµ‹è¯•

### Python æµ‹è¯•æœåŠ¡ç«¯

```bash
# è®¾ç½®ç«¯å£ï¼ˆå¯é€‰ï¼‰
export MCP_TEST_SERVER_PORT=8080

# å¯åŠ¨æµ‹è¯•æœåŠ¡ç«¯
python test_mcp_http_server.py
```

### æµ‹è¯•å‘½ä»¤

```
>>> list      # æ˜¾ç¤ºå·¥å…·åˆ—è¡¨
>>> jvm       # è°ƒç”¨ jvm å·¥å…·
>>> thread    # è°ƒç”¨ thread å·¥å…·
>>> memory    # è°ƒç”¨ memory å·¥å…·
>>> call <name> [json_args]  # è°ƒç”¨æŒ‡å®šå·¥å…·
```

## ğŸ“ æ–‡ä»¶åˆ—è¡¨

### Java æºæ–‡ä»¶

| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|-----|------|-----|
| `McpClientConfig.java` | ~320 | é…ç½®ç±»ï¼Œæ”¯æŒç¯å¢ƒå˜é‡ |
| `ArthasMcpClient.java` | ~300 | ä¸»å®¢æˆ·ç«¯ç±» |
| `McpHttpClient.java` | ~480 | HTTP/SSE è¿æ¥ |
| `McpClientProtocolHandler.java` | ~280 | åè®®å¤„ç† |
| `ReconnectStrategy.java` | ~95 | é‡è¿ç­–ç•¥ |
| `HeartbeatManager.java` | ~115 | å¿ƒè·³ç®¡ç† |
| `McpClientBootstrap.java` | ~90 | æµ‹è¯•å…¥å£ |

### Python æµ‹è¯•è„šæœ¬

| æ–‡ä»¶ | è¯´æ˜ |
|-----|-----|
| `test_mcp_http_server.py` | HTTP/SSE æ¨¡å¼æµ‹è¯•æœåŠ¡ç«¯ |

## ğŸ”’ å®‰å…¨ç‰¹æ€§

1. **è®¤è¯æ”¯æŒ**: `Authorization: Bearer <token>` å¤´
2. **SSL/TLS**: æ”¯æŒ `https://` åŠ å¯†è¿æ¥
3. **è‡ªåŠ¨é‡è¿**: æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆ5s, 10s, 20s, ... æœ€å¤§ 5minï¼‰
4. **å¿ƒè·³ä¿æ´»**: é»˜è®¤ 30 ç§’é—´éš”ï¼Œ10 ç§’è¶…æ—¶
5. **ä¼šè¯ç®¡ç†**: é€šè¿‡ `Mcp-Session-Id` å¤´ç»´æŠ¤ä¼šè¯

## ğŸ”„ ä¸åŸæœ‰ Server æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | Server æ¨¡å¼ | Client æ¨¡å¼ï¼ˆåå‘è¿æ¥ï¼‰ |
|------|-------------|------------------------|
| è¿æ¥æ–¹å‘ | å®¢æˆ·ç«¯è¿æ¥ Arthas | Arthas è¿æ¥ç®¡æ§å¹³å° |
| ç«¯å£æš´éœ² | éœ€è¦æš´éœ²ç«¯å£ | æ— éœ€æš´éœ²ç«¯å£ |
| åè®® | HTTP/SSE | HTTP/SSE |
| é€‚ç”¨åœºæ™¯ | æœ¬åœ°å¼€å‘ã€åŒç½‘æ®µ | å†…ç½‘ç©¿é€ã€ç»Ÿä¸€ç®¡æ§ |

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **åè®®å…¼å®¹**: ä½¿ç”¨ç›¸åŒçš„ MCP åè®®ç‰ˆæœ¬ï¼ˆ2025-03-26ï¼‰
2. **å·¥å…·å¤ç”¨**: å®Œå…¨å¤ç”¨ç°æœ‰çš„ ToolCallback å®ç°
3. **é‡è¿æœºåˆ¶**: ç½‘ç»œæ–­å¼€åè‡ªåŠ¨é‡è¿
4. **ä¼šè¯ä¿æŒ**: é‡è¿åä¼šè¯ ID å¯èƒ½æ”¹å˜
